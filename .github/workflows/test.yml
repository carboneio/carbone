name: Test
on:
  # https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows
  # triggers https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions
  # Manual trigger
  workflow_dispatch:
  # Automatic trigger
  pull_request:
    branches: [ master, main, enterprise-edition-master ]
  
  # Manual event   
jobs:
  test:
    # https://docs.github.com/en/actions/learn-github-actions/environment-variables
    env:
      LIBREOFFICE_VERSION: 7.0.4.2
      NODE_VERSION: 16.13.0
    
    # Content of github object
    # https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
    # ALternative if: "contains(github.event.head_commit.message, '@review')"
    if: ${{ github.event_name == 'workflow_dispatch' || !contains( github.event.pull_request.title, 'WIP:' }}

    # The maximum number of minutes to let a job run before GitHub automatically cancels it
    timeout-minutes: 10
    # Content of the Ubuntu image: https://github.com/actions/virtual-environments/blob/main/images/linux/Ubuntu2004-README.md
    # List of available platform: https://github.com/actions/virtual-environments
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node: [ '16.13.0' ]
    name: Node ${{ matrix.node }} test
    steps:
      # Checkout source code of the project
      - uses: actions/checkout@v2

      # Performance tips #1
      # Cache NodeJS and project NPM dependencies using a hash of package-lock.json as the invalidation key
      # https://docs.github.com/en/actions/advanced-guides/caching-dependencies-to-speed-up-workflows
      # https://github.com/actions/setup-node
      - name: Setup node using cache (faster)
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
      
      # Github images contains most of these dependancies but install it anyway 
      - name: Install LibreOffice Dependencies
        run: |
          sudo apt-get install libxinerama1 libfontconfig1 libdbus-glib-1-2 libcairo2 libcups2 libglu1-mesa libsm6

      # darwin: sudo systemsetup -settimezone Europe/Paris
      # win: tzutil /s Europe/Paris
      - name: Set Timezone for testing
        run: |
          sudo timedatectl set-timezone Europe/Paris

      # Performance tips #2
      # https://github.com/actions/cache
      # Here is a complex example which use dpkg to list all installed deps: https://stackoverflow.com/questions/59269850/caching-apt-packages-in-github-actions-workflow
      - name: Install Libreoffice using cache
        id: libreoffice-cache
        uses: actions/cache@v2
        with:
          path: |
            /opt/libreoffice**
          # Invalidate cache if Libreoffice version change, or os change
          key: ${{ runner.os }}-${{ env.LIBREOFFICE_VERSION }}

      - name: Install LibreOffice if cache is invalid
        # If the cache is empty
        if: steps.libreoffice-cache.outputs.cache-hit != 'true'
        run: |
          wget https://downloadarchive.documentfoundation.org/libreoffice/old/${{env.LIBREOFFICE_VERSION}}/deb/x86_64/LibreOffice_${{env.LIBREOFFICE_VERSION}}_Linux_x86-64_deb.tar.gz
          tar -zxvf LibreOffice_${{env.LIBREOFFICE_VERSION}}_Linux_x86-64_deb.tar.gz
          cd LibreOffice_${{env.LIBREOFFICE_VERSION}}_Linux_x86-64_deb/DEBS
          sudo dpkg -i *.deb

      # Use npm "ci" instead of "i" to use only package-lock.json as source
      - run: npm ci
      - run: npm test


# Deploy with git actions
# https://levelup.gitconnected.com/how-to-manually-trigger-a-github-actions-workflow-4712542f1960
# 
# Same on Mac
# https://github.com/metanorma/reverse_adoc/actions/runs/26372536/workflow
# 
# Technique pour deboucing les actions
# https://stackoverflow.com/questions/63014786/how-to-schedule-a-github-actions-nightly-build-but-run-it-only-when-there-where
# 
# Nous, on peut pas utiliser les draft_request
# https://github.community/t/dont-run-actions-on-draft-pull-requests/16817/16
# 
# Mais on peut lire le titre de la pull request et d√©tecter le WIP